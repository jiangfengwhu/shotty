<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/fabric@6.4.2/dist/index.min.js"></script>
</head>
<body>
<input type="file" id="file" />
<div id="canvas-wrapper">
<canvas id="canvas"></canvas>
</div>
<div id="debug"></div>
<button onclick="downloadResult()">下载处理结果</button>
<h1 id="">hhh</h1>
<img id='capturedImage' style="object-fit: cover;width: 100%"/>
</body>
<script type="text/javascript">
  let canvas = null;
  function resizeCanvas(canvas) {
    const outerCanvasContainer = document.getElementById('canvas-wrapper');

    const ratio = 1.;
    const containerWidth   = outerCanvasContainer.clientWidth;

    const scale = containerWidth / canvas.getWidth();
    const zoom  = canvas.getZoom() * scale;
    canvas.setDimensions({width: containerWidth, height: containerWidth / ratio});
    canvas.setViewportTransform([zoom, 0, 0, zoom, 0, 0]);
  }

  window.onload = function() {
    const img = document.getElementById('capturedImage');
    img.src = `data:image/png;base64,${window.shottyImageBase64}`;
    canvas = new fabric.Canvas('canvas');
    const rect = new fabric.Rect({
      top: 100,
      left: 100,
      width: 60,
      height: 70,
      fill: 'red',
    });
    resizeCanvas(canvas)
    canvas.add(rect);
    window.onShottyImage = function(base64) {
      const img = document.getElementById('capturedImage');
      img.src = `data:image/png;base64,${base64}`;
      img.onload = () => {
        const image = new fabric.Image(img)
        canvas.add(image);
      }
    }
    window.addEventListener('resize', () => {
      resizeCanvas(canvas)
    });
  }
  function downloadResult() {
    const url = canvas.toDataURL({
      format: 'png',
      multiplier: window.devicePixelRatio
    });
    console.log('zxzx ,', url);
    const div = document.getElementById('debug');
    div.innerHTML = JSON.stringify(window.webkit.messageHandlers.saveBase64ImageHandler.postMessage);
    window.webkit.messageHandlers.saveBase64ImageHandler.postMessage?.(url);
  }
</script>
</html>
